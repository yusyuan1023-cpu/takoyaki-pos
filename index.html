<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>章魚燒 POS - 完整優化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8F7F5; color: #4A443F; }
        
        .container-tight { width: 95%; margin: 0 auto; }
        .frame-box { background: white; border-radius: 0.8rem; padding: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .sub-card { background: #F9FAFB; border-radius: 0.7rem; padding: 0.75rem; }
        
        /* 側邊欄與彈窗 */
        .side-panel { position: fixed; top: 0; right: -100%; width: 85%; max-width: 340px; height: 100%; background: white; z-index: 150; transition: 0.3s ease; display: flex; flex-direction: column; }
        .side-panel.active { right: 0; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 140; backdrop-filter: blur(1px); }
        .overlay.active { display: block; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-box { width: 100%; max-width: 330px; border-radius: 1.25rem; overflow: hidden; }

        /* 按鈕與字體微調 */
        .option-btn { border: 1.5px solid #EDF2F7; padding: 6px; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; background: white; cursor: pointer; }
        .option-btn.active { border-color: #8C7A6D; background: #FDFBF9; color: #8C7A6D; font-weight: bold; }
        .calc-btn { background: #F7F9FC; border-radius: 0.7rem; font-weight: 700; font-size: 1.1rem; height: 46px; display: flex; align-items: center; justify-content: center; }
        
        .scroll-v { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .refund-wrapper { position: relative; overflow: hidden; border-radius: 0.7rem; }
        .refund-layer { position: absolute; right: 0; top: 0; bottom: 0; width: 65px; background: #EF4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; transform: translateX(100%); transition: 0.2s; z-index: 10; cursor: pointer; }
        .refund-wrapper.open .refund-layer { transform: translateX(0); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <nav class="bg-white h-14 border-b flex justify-between items-center px-4 shrink-0 z-50">
        <div class="flex flex-col">
            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">System v14</span>
            <span id="order-id-display" class="text-lg font-black font-mono text-[#8C7A6D]">#001</span>
        </div>
        <div class="flex gap-6">
            <button onclick="showTab('order')" id="nav-order" class="flex flex-col items-center text-[#8C7A6D]"><i data-lucide="layout-grid" class="w-4.5 h-4.5"></i><span class="text-[10px] font-bold">點餐</span></button>
            <button onclick="showTab('ongoing')" id="nav-ongoing" class="flex flex-col items-center text-gray-300 relative"><i data-lucide="flame" class="w-4.5 h-4.5"></i><span id="ongoing-badge" class="absolute -top-1 -right-2 bg-orange-500 text-white text-[8px] w-4 h-4 rounded-full hidden flex items-center justify-center">0</span><span class="text-[10px] font-bold">製作</span></button>
            <button onclick="showTab('history')" id="nav-history" class="flex flex-col items-center text-gray-300"><i data-lucide="bar-chart-3" class="w-4.5 h-4.5"></i><span class="text-[10px] font-bold">數據</span></button>
        </div>
    </nav>

    <main id="main-content" class="flex-1 scroll-v py-4"></main>

    <div id="bottom-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 pb-6 flex justify-between items-center shadow-lg z-40">
        <div onclick="toggleSidePanel(true)" class="flex flex-col cursor-pointer pl-1">
            <span class="text-[10px] text-orange-500 font-bold uppercase tracking-wider">Order Total</span>
            <span class="text-2xl font-black font-mono text-[#8C7A6D]">$<span id="total-amount">0</span></span>
        </div>
        <button onclick="toggleSidePanel(true)" class="bg-[#8C7A6D] text-white px-7 py-3 rounded-xl font-bold text-sm active:scale-95 transition-transform">確認結帳</button>
    </div>

    <div id="overlay" class="overlay" onclick="toggleSidePanel(false)"></div>
    <div id="side-panel" class="side-panel">
        <div class="p-5 border-b flex justify-between items-center bg-white shrink-0">
            <h3 class="font-black text-base">目前訂單內容</h3>
            <button onclick="toggleSidePanel(false)"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="side-cart-items" class="flex-1 scroll-v p-4 space-y-3"></div>
        <div class="p-5 border-t bg-gray-50 rounded-t-2xl shrink-0">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[11px] font-bold text-gray-400">總金額</span>
                <span class="text-3xl font-black font-mono text-[#8C7A6D]">$<span id="side-total">0</span></span>
            </div>
            <button onclick="openPaymentModal()" class="w-full py-4 bg-[#8C7A6D] text-white rounded-xl font-bold text-sm shadow-md mb-2">確認支付</button>
            <button onclick="clearCart()" class="w-full py-1 text-red-400 font-bold text-[10px]">清空內容</button>
        </div>
    </div>

    <div id="modal-container" class="modal">
        <div class="modal-box frame-box max-h-[85vh] scroll-v" id="modal-content"></div>
    </div>

    <script>
        const MENU = [
            {id:1, name:'原味章魚燒', price:60}, {id:2, name:'海苔章魚燒', price:60},
            {id:3, name:'芥末章魚燒', price:60}, {id:4, name:'梅子章魚燒', price:60},
            {id:5, name:'蜂蜜芥末', price:60}, {id:6, name:'咖哩章魚燒', price:60},
            {id:7, name:'辣味章魚燒', price:60}, {id:8, name:'金沙鹹蛋黃', price:70},
            {id:9, name:'起司章魚燒', price:70}, {id:10, name:'龍蝦沙拉', price:80}
        ];
        const ADDONS = [{id:'spicy', name:'加辣味', p:5}, {id:'seaweed', name:'加海苔', p:5}, {id:'wasabi', name:'加芥末', p:5}, {id:'cheese', name:'加起司', p:10}];
        const CUSTOMS = ['美乃滋','柴魚片','醬油'], LEVELS = ['正常','少','多','不要'];

        let cart = [], ongoing = [], history = [], closedLogs = [], orderNum = 1, editingIndex = -1, tempItem = null;

        function init() {
            const saved = JSON.parse(localStorage.getItem('pos_v14_data') || '{}');
            const today = new Date().toLocaleDateString();
            if(saved.day === today) {
                ongoing = saved.ongoing || []; history = saved.history || []; orderNum = saved.orderNum || 1;
            } else if (saved.day) {
                executeClear(saved.day, saved.history || []);
            }
            closedLogs = JSON.parse(localStorage.getItem('closed_v14_logs') || '[]');
            showTab('order');
            setInterval(() => {
                const now = new Date().toLocaleDateString();
                const cur = JSON.parse(localStorage.getItem('pos_v14_data') || '{}');
                if(cur.day && cur.day !== now) { executeClear(cur.day, cur.history || []); location.reload(); }
            }, 30000);
        }

        function showTab(t) {
            const main = document.getElementById('main-content');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-[#8C7A6D]', 'text-gray-300'));
            document.getElementById('nav-'+t).classList.replace('text-gray-300', 'text-[#8C7A6D]');
            document.getElementById('bottom-bar').style.display = (t==='order') ? 'flex' : 'none';

            let html = `<div class="container-tight">`;
            if(t==='order') {
                html += `<div class="grid grid-cols-3 gap-3 pb-10">` + MENU.map(f => `
                    <div onclick="openEditor(${f.id})" class="frame-box p-3 active:scale-95 transition-all cursor-pointer flex flex-col items-center justify-center min-h-[70px]">
                        <div class="font-bold text-[11px] text-center mb-1 leading-tight">${f.name}</div>
                        <div class="text-[#8C7A6D] font-black font-mono text-[12px]">$${f.price}</div>
                    </div>`).join('') + `</div>`;
            } else if(t==='ongoing') {
                html += ongoing.length ? ongoing.map((o, idx) => `
                    <div class="frame-box mb-3 border border-gray-100">
                        <div class="flex justify-between border-b pb-2 mb-2 items-center">
                            <span class="font-black text-[12px]">訂單 #${String(o.id).padStart(3,'0')} <span class="text-[9px] text-gray-400 font-normal ml-2">${o.time}</span></span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full ${o.status==='未付'?'bg-red-50 text-red-500':'bg-green-50 text-green-600'} font-bold">${o.status}</span>
                        </div>
                        <div class="text-[11px] space-y-2 mb-3">${o.items.map(i => `
                            <div>
                                <b class="text-gray-700">• ${i.name}</b>
                                ${i.hName ? `<div class="text-[10px] text-orange-600 font-bold ml-3">└ 雙拼組合：${i.hName}</div>` : ''}
                                <div class="text-[9px] text-gray-400 ml-3">└ 明細：${i.fullDesc}</div>
                            </div>`).join('')}
                        </div>
                        <div class="flex gap-2">
                            ${o.status==='未付' ? `<button onclick="repay(${idx})" class="flex-1 py-2.5 bg-orange-400 text-white rounded-lg text-[11px] font-bold shadow-sm">補收款</button>` : ''}
                            <button onclick="finishOrder(${idx})" class="flex-1 py-2.5 bg-[#8C7A6D] text-white rounded-lg text-[11px] font-bold shadow-sm">出餐完成</button>
                        </div>
                    </div>`).join('') : `<p class="text-center py-20 text-gray-300 text-[11px] font-bold">目前沒有製作中訂單</p>`;
            } else if(t==='history') {
                const s = history.reduce((acc, o) => { acc.total += o.total; acc[o.pay] = (acc[o.pay]||0)+o.total; return acc; }, { total:0, '現金':0, '行動支付':0, 'Foodpanda':0, 'UberEats':0 });
                html += `
                    <div class="frame-box mb-4">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-black text-[12px]">今日結算</h3><button onclick="executeClear()" class="bg-red-50 text-red-500 text-[10px] px-3 py-1.5 rounded-full font-bold">手動清帳結轉</button></div>
                        <div class="grid grid-cols-2 gap-2 text-[11px]">
                            <div class="sub-card py-2 flex justify-between"><span>現金:</span><b class="text-green-600">$${s['現金']}</b></div>
                            <div class="sub-card py-2 flex justify-between"><span>數位:</span><b class="text-blue-600">$${s['行動支付']}</b></div>
                        </div>
                        <div class="mt-4 pt-4 border-t text-center"><p class="text-[10px] text-gray-400 font-bold">TODAY TOTAL</p><p class="text-3xl font-black text-[#8C7A6D] font-mono">$${s.total}</p></div>
                    </div>
                    <div class="space-y-2 mb-8">${history.map((o, idx) => `
                        <div class="refund-wrapper" id="h-${idx}">
                            <div onclick="refundOrder(${idx})" class="refund-layer">退款</div>
                            <div class="sub-card flex justify-between items-center relative z-20" onclick="document.getElementById('h-${idx}').classList.toggle('open')">
                                <div class="text-[10px] font-bold">#${o.id} - ${o.pay}</div>
                                <div class="font-black font-mono text-base">$${o.total}</div>
                            </div>
                        </div>`).join('')}</div>
                    <div class="space-y-2 pb-12">${closedLogs.map((l, lIdx) => `
                        <div onclick="showLogDetail(${lIdx})" class="frame-box py-3 px-4 flex justify-between items-center text-[11px] cursor-pointer mb-1">
                            <span><b>${l.date}</b> 歷史清帳記錄</span>
                            <span class="font-black text-[#8C7A6D] font-mono">$${l.stats.total} ❯</span>
                        </div>`).join('')}</div>`;
            }
            html += `</div>`;
            main.innerHTML = html;
            lucide.createIcons(); updateUI();
        }

        function openEditor(id, cartIdx = -1) {
            editingIndex = cartIdx;
            if(cartIdx === -1) {
                const base = MENU.find(m => m.id === id);
                tempItem = { ...base, hId: null, customs: {'美乃滋':'正常','柴魚片':'正常','醬油':'正常'}, addons: [] };
            } else {
                tempItem = JSON.parse(JSON.stringify(cart[cartIdx]));
            }
            renderEditorUI();
            document.getElementById('modal-container').classList.add('active');
        }

        function renderEditorUI() {
            document.getElementById('modal-content').innerHTML = `
                <div class="p-5">
                    <h3 class="font-black text-base mb-5 text-center">${editingIndex === -1 ? '點購新餐點' : '修改餐點細節'}</h3>
                    <div class="space-y-5">
                        <section><p class="text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-wide">雙拼組合 (補差價)</p>
                            <div class="grid grid-cols-3 gap-2"><div onclick="updOpt('h',null)" class="option-btn ${!tempItem.hId?'active':''}">不雙拼</div>
                            ${MENU.map(m => `<div onclick="updOpt('h',${m.id})" class="option-btn ${tempItem.hId===m.id?'active':''}">${m.name.replace('章魚燒','')}</div>`).join('')}</div></section>
                        <section>${CUSTOMS.map(c => `<div class="mb-4"><p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">${c}</p><div class="grid grid-cols-4 gap-1.5">${LEVELS.map(l => `<div onclick="updOpt('c','${c}','${l}')" class="option-btn ${tempItem.customs[c]===l?'active':''}">${l}</div>`).join('')}</div></div>`).join('')}</section>
                        <section><p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">加購配料</p>
                            <div class="grid grid-cols-2 gap-2">${ADDONS.map(a => `<div onclick="updOpt('a','${a.id}')" class="option-btn ${tempItem.addons.includes(a.id)?'active':''}">${a.name}</div>`).join('')}</div></section>
                    </div>
                    <div class="flex gap-2 mt-8">
                        ${editingIndex !== -1 ? `<button onclick="cart.splice(editingIndex,1); closeModals(); renderCart();" class="flex-1 py-3.5 text-red-500 font-bold border rounded-xl text-xs">移除</button>` : ''}
                        <button onclick="saveToCart()" class="flex-[2] bg-[#8C7A6D] text-white py-3.5 rounded-xl font-bold text-xs shadow-sm">確認送出</button>
                    </div>
                    <button onclick="closeModals()" class="w-full mt-4 text-[10px] text-gray-400 font-bold uppercase">取消</button>
                </div>`;
        }

        function updOpt(t,p1,p2){
            if(t==='h') tempItem.hId = p1;
            else if(t==='c') tempItem.customs[p1] = p2;
            else if(t==='a') { const i = tempItem.addons.indexOf(p1); if(i>-1) tempItem.addons.splice(i,1); else tempItem.addons.push(p1); }
            renderEditorUI();
        }

        function saveToCart() {
            let hFee = 0, hName = "";
            if(tempItem.hId) {
                hName = MENU.find(m => m.id === tempItem.hId).name;
                hFee = (tempItem.hId===8||tempItem.hId===9) ? 5 : (tempItem.hId===10 ? 10 : 0);
            }
            let addonFee = tempItem.addons.reduce((s, aId) => s + ADDONS.find(a => a.id === aId).p, 0);
            const desc = Object.entries(tempItem.customs).map(([k,v])=>v!=='正常'?k+v:'').filter(v=>v).join(',') + (tempItem.addons.length ? ' | 加:'+tempItem.addons.map(a=>ADDONS.find(ad=>ad.id===a).name.slice(-2)).join(',') : '');
            const finalObj = { ...tempItem, finalTotal: tempItem.price + hFee + addonFee, hName, fullDesc: desc || '正常標配' };
            if(editingIndex === -1) cart.push(finalObj); else cart[editingIndex] = finalObj;
            closeModals(); updateUI(); if(document.getElementById('side-panel').classList.contains('active')) renderCart();
        }

        function toggleSidePanel(show) {
            document.getElementById('side-panel').classList.toggle('active', show);
            document.getElementById('overlay').classList.toggle('active', show);
            if(show) renderCart();
        }

        function renderCart() {
            const list = document.getElementById('side-cart-items');
            list.innerHTML = cart.length ? cart.map((i, idx) => `
                <div onclick="openEditor(${i.id}, ${idx})" class="sub-card border-l-4 border-[#8C7A6D] p-3">
                    <div class="flex justify-between font-black text-[12px]"><span>${i.name}</span><span class="text-[#8C7A6D] font-mono">$${i.finalTotal}</span></div>
                    <div class="mt-1">
                        ${i.hName ? `<div class="text-[10px] text-orange-600 font-bold">拼: ${i.hName}</div>` : ''}
                        <div class="text-[9px] text-gray-400 font-bold italic">明細: ${i.fullDesc}</div>
                    </div>
                </div>`).join('') : `<div class="text-center py-20 text-gray-300 text-[11px] font-bold">尚未加入任何餐點...</div>`;
            const total = cart.reduce((s,i)=>s+i.finalTotal, 0);
            document.getElementById('side-total').innerText = total;
            document.getElementById('total-amount').innerText = total;
        }

        // 核心結帳功能與修復
        let repayIdx = -1; // 用於追蹤正在補款的訂單

        function openPaymentModal(isRepay = false, index = -1) {
            const due = isRepay ? ongoing[index].total : cart.reduce((s,i)=>s+i.finalTotal,0);
            if(due <= 0 && !isRepay) return;
            repayIdx = index; 

            document.getElementById('modal-content').innerHTML = `
                <div id="pay-main" class="p-6">
                    <h3 class="font-black text-base mb-5 text-center">${isRepay ? '訂單補收款' : '選擇結帳管道'}</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="startCalc(${due})" class="sub-card p-4 flex flex-col items-center gap-2 border hover:border-gray-300 transition-colors"><i data-lucide="banknote" class="w-6 h-6 text-green-500"></i><b class="text-[11px]">現金結帳</b></button>
                        <button onclick="submitOrder('行動支付')" class="sub-card p-4 flex flex-col items-center gap-2 border hover:border-gray-300 transition-colors"><i data-lucide="smartphone" class="w-6 h-6 text-blue-500"></i><b class="text-[11px]">行動支付</b></button>
                        <button onclick="submitOrder('Foodpanda')" class="sub-card p-4 flex flex-col items-center gap-2 border hover:border-gray-300 transition-colors"><i data-lucide="truck" class="w-6 h-6 text-pink-500"></i><b class="text-[11px]">Panda</b></button>
                        <button onclick="submitOrder('UberEats')" class="sub-card p-4 flex flex-col items-center gap-2 border hover:border-gray-300 transition-colors"><i data-lucide="shopping-bag" class="w-6 h-6 text-emerald-500"></i><b class="text-[11px]">UberEats</b></button>
                        ${!isRepay ? `<button onclick="submitOrder('待付款')" class="col-span-2 py-4 bg-orange-50 text-orange-500 rounded-xl text-[11px] font-bold">待會收錢 (先出單)</button>` : ''}
                    </div>
                    <button onclick="closeModals()" class="w-full mt-5 text-[10px] text-gray-400 font-bold uppercase">取消</button>
                </div>
                <div id="calc-area" class="hidden p-6">
                    <div class="bg-[#8C7A6D] p-5 rounded-2xl mb-4 text-white">
                        <div class="flex justify-between items-end font-mono"><div class="text-3xl font-black" id="calc-in">0</div><div class="text-xl font-bold" id="calc-ch">$0</div></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        ${[1,2,3,4,5,6,7,8,9, 'C', 0].map(n => `<button onclick="pressCalc('${n}', ${due})" class="calc-btn">${n}</button>`).join('')}
                        <button onclick="submitOrder('現金')" class="calc-btn bg-orange-600 text-white text-sm font-black shadow-sm">OK</button>
                    </div>
                </div>`;
            lucide.createIcons(); document.getElementById('modal-container').classList.add('active');
        }

        // 修復補收款按鍵
        function repay(idx) {
            openPaymentModal(true, idx);
        }

        let cVal = "";
        function startCalc() { document.getElementById('pay-main').classList.add('hidden'); document.getElementById('calc-area').classList.remove('hidden'); cVal = ""; }
        function pressCalc(v, due) {
            if(v==='C') cVal = ""; else cVal += v.toString();
            document.getElementById('calc-in').innerText = cVal || "0";
            const ch = parseInt(cVal || 0) - due;
            document.getElementById('calc-ch').innerText = ch >= 0 ? "$" + ch : "$0";
        }

        function submitOrder(method) {
            if(repayIdx !== -1) {
                // 如果是補收款
                ongoing[repayIdx].pay = method;
                ongoing[repayIdx].status = '已付';
                repayIdx = -1;
            } else {
                // 如果是新訂單
                const due = cart.reduce((s,i)=>s+i.finalTotal,0);
                ongoing.push({ 
                    id: orderNum++, 
                    items: [...cart], 
                    total: due, 
                    pay: method, 
                    status: method==='待付款'?'未付':'已付', 
                    time: new Date().toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'}) 
                });
                cart = [];
            }
            closeModals(); toggleSidePanel(false); showTab('ongoing'); save();
        }

        function finishOrder(idx) { 
            if(ongoing[idx].status === '未付') return alert('這筆還沒付錢喔！請先補收款。');
            history.unshift(ongoing[idx]); ongoing.splice(idx,1); showTab('ongoing'); save(); 
        }

        function refundOrder(idx) { if(confirm('要退款這筆訂單嗎？')) { history.splice(idx,1); showTab('history'); save(); } }

        function executeClear(dateStr = new Date().toLocaleDateString(), histData = history) {
            if(!histData.length && dateStr === new Date().toLocaleDateString()) { alert('目前沒有可清帳的數據'); return; }
            const stats = histData.reduce((acc, o) => { acc.total += o.total; acc[o.pay] = (acc[o.pay]||0)+o.total; return acc; }, { total:0, '現金':0, '行動支付':0, 'Foodpanda':0, 'UberEats':0 });
            closedLogs.unshift({ date: dateStr, stats });
            localStorage.setItem('closed_v14_logs', JSON.stringify(closedLogs));
            history = []; orderNum = 1; save(); showTab('history');
            if(dateStr === new Date().toLocaleDateString()) alert('✅ 當日結轉完成！數據已存入日誌。');
        }

        function showLogDetail(idx) {
            const l = closedLogs[idx];
            document.getElementById('modal-content').innerHTML = `
                <div class="p-6">
                    <h3 class="font-black text-sm mb-5 text-center">${l.date} 營收統計報表</h3>
                    <div class="space-y-4 text-[12px]">
                        <div class="flex justify-between border-b pb-2"><span>現金收入</span><b class="text-green-600 font-mono">$${l.stats['現金']}</b></div>
                        <div class="flex justify-between border-b pb-2"><span>行動支付</span><b class="text-blue-600 font-mono">$${l.stats['行動支付']}</b></div>
                        <div class="flex justify-between border-b pb-2"><span>Foodpanda</span><b class="text-pink-500 font-mono">$${l.stats['Foodpanda']}</b></div>
                        <div class="flex justify-between border-b pb-2"><span>UberEats</span><b class="text-emerald-500 font-mono">$${l.stats['UberEats']}</b></div>
                        <div class="flex justify-between pt-3"><span class="font-black text-base">總營業額</span><span class="font-black text-2xl text-[#8C7A6D] font-mono">$${l.stats.total}</span></div>
                    </div>
                    <button onclick="closeModals()" class="w-full mt-8 py-3.5 bg-gray-100 rounded-xl font-bold text-[12px]">關閉視窗</button>
                </div>`;
            document.getElementById('modal-container').classList.add('active');
        }

        function clearCart() { cart = []; renderCart(); updateUI(); toggleSidePanel(false); }
        function closeModals() { document.getElementById('modal-container').classList.remove('active'); repayIdx = -1; }
        
        function updateUI() {
            const total = cart.reduce((s,i)=>s+i.finalTotal, 0);
            document.getElementById('total-amount').innerText = total;
            document.getElementById('ongoing-badge').innerText = ongoing.length;
            document.getElementById('ongoing-badge').classList.toggle('hidden', !ongoing.length);
            document.getElementById('order-id-display').innerText = '#' + String(orderNum).padStart(3, '0');
        }

        function save() { localStorage.setItem('pos_v14_data', JSON.stringify({ day: new Date().toLocaleDateString(), ongoing, history, orderNum })); }

        init();
    </script>
</body>
</html>
