<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>章魚燒 POS - 雙拼專業版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: flex-end; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 2rem 2rem 0 0; padding: 2rem; animation: slideUp 0.2s ease-out; overflow-y: auto; max-height: 90vh; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .option-btn { border: 2px solid #F3F4F6; padding: 10px; border-radius: 1rem; text-align: center; font-size: 0.825rem; transition: all 0.2s; cursor: pointer; }
        .option-btn.selected { border-color: #8C7A6D; background: #FDFBF9; color: #8C7A6D; font-weight: bold; }
        .payment-btn { border: 2px solid #F3F4F6; padding: 15px; border-radius: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 8px; font-weight: bold; font-size: 0.875rem; }
        .payment-btn.active { border-color: #8C7A6D; background: #FDFBF9; color: #8C7A6D; }
        .order-card { background: white; border-radius: 1.5rem; padding: 1.25rem; margin-bottom: 1rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    </style>
</head>
<body class="bg-[#F7F5F0] text-[#5C544B]">
    <div class="flex flex-col h-screen overflow-hidden">
        <nav class="bg-white h-16 border-b flex justify-between items-center px-6 shadow-sm shrink-0">
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ORDER NO.</span>
                <span id="order-id-display" class="text-xl font-black font-mono text-[#8C7A6D]">#001</span>
            </div>
            <div class="flex gap-5">
                <button onclick="showTab('order')" id="nav-order" class="flex flex-col items-center text-[#8C7A6D]">
                    <i data-lucide="utensils-crossed" class="w-5 h-5"></i><span class="text-[10px] font-bold">點餐</span>
                </button>
                <button onclick="showTab('ongoing')" id="nav-ongoing" class="flex flex-col items-center text-gray-300 relative">
                    <i data-lucide="flame" class="w-5 h-5"></i>
                    <span id="ongoing-badge" class="absolute -top-1 -right-2 bg-orange-500 text-white text-[9px] w-4 h-4 rounded-full hidden flex items-center justify-center">0</span>
                    <span class="text-[10px] font-bold">進行中</span>
                </button>
                <button onclick="showTab('history')" id="nav-history" class="flex flex-col items-center text-gray-300">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i><span class="text-[10px] font-bold">數據</span>
                </button>
            </div>
        </nav>

        <main id="main-content" class="flex-1 overflow-y-auto p-4 pb-32">
            </main>

        <div id="bottom-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 pb-8 flex justify-between items-center shadow-lg">
            <div onclick="showTab('cart')" class="flex flex-col cursor-pointer">
                <span class="text-[10px] text-gray-400 font-bold flex items-center gap-1">購物車明細 <i data-lucide="chevron-up" class="w-3 h-3"></i></span>
                <span class="text-2xl font-black font-mono text-[#8C7A6D]">$<span id="total-amount">0</span></span>
            </div>
            <button onclick="openCheckoutModal()" class="bg-[#8C7A6D] text-white px-10 py-4 rounded-2xl font-bold shadow-lg active:scale-95">送出訂單</button>
        </div>
    </div>

    <div id="option-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-item-name" class="font-black text-xl">商品名稱</h3>
                <button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-widest">雙拼第二口味 (選填)</p>
                    <div id="half-grid" class="grid grid-cols-3 gap-2"></div>
                </div>
                <div id="custom-sections" class="space-y-4"></div>
                <div>
                    <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-widest">加購 (可複選)</p>
                    <div id="addon-grid" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>
            <button id="modal-confirm-btn" onclick="addToCart()" class="w-full bg-[#8C7A6D] text-white py-4 rounded-2xl font-bold mt-8">加入購物車</button>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-black text-xl mb-6">選擇付款方式</h3>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="selectPayment('現金')" class="payment-btn pay-opt"><i data-lucide="banknote"></i>現金</button>
                <button onclick="selectPayment('行動支付')" class="payment-btn pay-opt"><i data-lucide="smartphone"></i>行動支付</button>
                <button onclick="selectPayment('Foodpanda')" class="payment-btn pay-opt"><i data-lucide="truck"></i>Foodpanda</button>
                <button onclick="selectPayment('UberEats')" class="payment-btn pay-opt"><i data-lucide="store"></i>UberEats</button>
                <button onclick="selectPayment('待付款')" class="payment-btn pay-opt col-span-2"><i data-lucide="clock"></i>待付款 (稍後補結)</button>
            </div>
            <div id="cash-input-section" class="hidden space-y-4 border-t pt-4">
                <p class="text-sm font-bold">實收現金：</p>
                <input type="number" id="cash-received" class="w-full bg-gray-100 p-4 rounded-xl text-xl font-mono" placeholder="輸入金額計算找零">
            </div>
            <button onclick="completeOrder()" class="w-full bg-[#5C544B] text-white py-4 rounded-2xl font-bold mt-6">確認送單</button>
        </div>
    </div>

    <script>
        const MENU = [
            {id:1, name:'原味章魚燒', price:60}, {id:2, name:'海苔章魚燒', price:60}, {id:3, name:'芥末章魚燒', price:60},
            {id:4, name:'梅子章魚燒', price:60}, {id:5, name:'蜂蜜芥末', price:60}, {id:6, name:'咖哩章魚燒', price:60},
            {id:7, name:'辣味章魚燒', price:60}, {id:8, name:'金沙鹹蛋黃', price:70}, {id:9, name:'起司章魚燒', price:70}, {id:10, name:'龍蝦沙拉', price:80}
        ];
        const HALF_FLAVORS = [
            {id:'none', name:'不雙拼', price:0}, {id:'original', name:'原味', price:0}, {id:'spicy', name:'辣味', price:0},
            {id:'seaweed', name:'海苔', price:0}, {id:'wasabi', name:'芥末', price:0}, {id:'plum', name:'梅子', price:0},
            {id:'honey', name:'蜂蜜芥末', price:0}, {id:'curry', name:'咖哩', price:0}, {id:'salted_egg', name:'金沙', price:0},
            {id:'cheese', name:'起司', price:5}, {id:'lobster', name:'龍蝦', price:10}
        ];
        const CUSTOMS = ['美乃滋','柴魚片','醬油'];
        const LEVELS = ['正常','少','多','不要'];
        const ADDONS = [{id:'spicy', name:'加辣', price:5}, {id:'seaweed', name:'加海苔', price:5}, {id:'wasabi', name:'加芥末', price:5}, {id:'cheese', name:'加起司', price:10}];

        let cart = [], orderNum = 1, dailyOrders = [], ongoingOrders = [], selectedPayment = '', activeItem = null, editIndex = -1, currentTab = 'order';

        function init() { showTab('order'); lucide.createIcons(); }

        function showTab(t) {
            currentTab = t;
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-[#8C7A6D]', 'text-gray-300'));
            const activeBtn = document.getElementById('nav-'+t);
            if(activeBtn) activeBtn.classList.replace('text-gray-300', 'text-[#8C7A6D]');
            
            document.getElementById('bottom-bar').style.display = (t==='order' || t==='cart') ? 'flex' : 'none';
            if(t==='order') renderOrderTab();
            else if(t==='cart') renderCartTab();
            else if(t==='ongoing') renderOngoingTab();
            else if(t==='history') renderHistoryTab();
            lucide.createIcons();
        }

        function renderOrderTab() {
            document.getElementById('main-content').innerHTML = `<div class="grid grid-cols-2 gap-3">` + 
                MENU.map(i => `<div onclick="openOptions(${i.id})" class="bg-white p-5 rounded-[1.8rem] border border-gray-100 shadow-sm active:bg-orange-50 transition-all"><div class="h-10 font-bold text-sm mb-2">${i.name}</div><div class="flex justify-between items-center"><span class="text-[#8C7A6D] font-mono font-black">$${i.price}</span><div class="bg-[#F2EBE5] text-[#8C7A6D] p-1 rounded-lg"><i data-lucide="plus" class="w-4 h-4"></i></div></div></div>`).join('') + `</div>`;
        }

        function openOptions(id, isEdit = false, index = -1) {
            editIndex = index;
            const item = isEdit ? cart[index] : MENU.find(m => m.id === id);
            activeItem = JSON.parse(JSON.stringify(item));
            if(!isEdit) { activeItem.customs = {'美乃滋':'正常','柴魚片':'正常','醬油':'正常'}; activeItem.addons = []; activeItem.half = 'none'; }

            document.getElementById('modal-item-name').innerText = activeItem.name;
            document.getElementById('half-grid').innerHTML = HALF_FLAVORS.map(h => `<div onclick="setHalf('${h.id}')" id="half-${h.id}" class="option-btn ${activeItem.half===h.id?'selected':''}">${h.name}${h.price>0?`+$${h.price}`:''}</div>`).join('');
            document.getElementById('custom-sections').innerHTML = CUSTOMS.map(c => `<div class="mb-2"><p class="text-[10px] font-bold text-gray-400 mb-1 uppercase">${c}</p><div class="grid grid-cols-4 gap-2">${LEVELS.map(l => `<div onclick="setCustom('${c}','${l}')" id="opt-${c}-${l}" class="option-btn ${activeItem.customs[c]===l?'selected':''}">${l}</div>`).join('')}</div></div>`).join('');
            document.getElementById('addon-grid').innerHTML = ADDONS.map(a => `<div onclick="toggleAddon('${a.id}')" id="addon-${a.id}" class="option-btn ${activeItem.addons.includes(a.id)?'selected':''}">${a.name}(+$${a.price})</div>`).join('');
            document.getElementById('option-modal').classList.add('active');
            lucide.createIcons();
        }

        function setHalf(id) { activeItem.half = id; HALF_FLAVORS.forEach(h => document.getElementById(`half-${h.id}`).classList.remove('selected')); document.getElementById(`half-${id}`).classList.add('selected'); }
        function setCustom(c, l) { activeItem.customs[c] = l; LEVELS.forEach(v => document.getElementById(`opt-${c}-${v}`).classList.remove('selected')); document.getElementById(`opt-${c}-${l}`).classList.add('selected'); }
        function toggleAddon(id) { const idx = activeItem.addons.indexOf(id); if(idx>-1) { activeItem.addons.splice(idx,1); document.getElementById(`addon-${id}`).classList.remove('selected'); } else { activeItem.addons.push(id); document.getElementById(`addon-${id}`).classList.add('selected'); } }
        function closeModal() { document.getElementById('option-modal').classList.remove('active'); }

        function addToCart() {
            const hPrice = HALF_FLAVORS.find(h => h.id === activeItem.half).price;
            const aPrice = activeItem.addons.reduce((s,id)=>s+(ADDONS.find(a=>a.id===id).price), 0);
            activeItem.finalPrice = activeItem.price + hPrice + aPrice;
            if(editIndex > -1) cart[editIndex] = activeItem; else cart.push(activeItem);
            updateCartUI(); closeModal();
        }

        function updateCartUI() { 
            const total = cart.reduce((s,i)=>s+i.finalPrice, 0);
            document.getElementById('total-amount').innerText = total;
            document.getElementById('cart-badge').innerText = cart.length; 
            document.getElementById('cart-badge').classList.toggle('hidden', cart.length===0);
        }

        function renderCartTab() {
            if(cart.length===0) { document.getElementById('main-content').innerHTML = `<div class="text-center py-20 text-gray-300">購物車是空的</div>`; return; }
            document.getElementById('main-content').innerHTML = `<h3 class="font-bold mb-4 px-2">點餐明細</h3>` + cart.map((i, idx) => `
                <div class="bg-white p-4 rounded-2xl shadow-sm mb-3 border border-gray-100">
                    <div class="flex justify-between font-bold"><span>${i.name} ${i.half!=='none'?'(雙拼'+HALF_FLAVORS.find(h=>h.id===i.half).name+')':''}</span><span>$${i.finalPrice}</span></div>
                    <div class="text-[10px] text-gray-400 mt-1">客製：${Object.entries(i.customs).map(([k,v])=>v!=='正常'?k+v:'').filter(v=>v).join(' ') || '全部正常'} ${i.addons.length?`| 加購：`+i.addons.map(aid=>ADDONS.find(a=>a.id===aid).name).join(' '):''}</div>
                    <div class="flex gap-2 mt-3"><button onclick="openOptions(0, true, ${idx})" class="text-[10px] bg-gray-50 px-3 py-1 rounded-md font-bold">修改</button><button onclick="cart.splice(${idx},1);updateCartUI();renderCartTab();" class="text-[10px] text-red-400 px-3 py-1 rounded-md font-bold">移除</button></div>
                </div>
            `).join('');
        }

        // --- 結帳與訂單流 ---
        function openCheckoutModal() { if(cart.length===0) return; document.getElementById('checkout-modal').classList.add('active'); lucide.createIcons(); }
        function selectPayment(p) { selectedPayment = p; document.querySelectorAll('.pay-opt').forEach(b=>b.classList.remove('active')); event.currentTarget.classList.add('active'); document.getElementById('cash-input-section').classList.toggle('hidden', p !== '現金'); }
        
        function completeOrder() {
            if(!selectedPayment) return;
            const total = cart.reduce((s,i)=>s+i.finalPrice,0);
            const order = { id: orderNum, items: [...cart], total, payment: selectedPayment, status: selectedPayment==='待付款'?'未付':'已付', time: new Date().toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'}) };
            ongoingOrders.push(order);
            cart = []; orderNum++; updateCartUI(); 
            document.getElementById('checkout-modal').classList.remove('active');
            document.getElementById('order-id-display').innerText = '#' + String(orderNum).padStart(3,'0');
            showTab('ongoing');
            updateBadge();
        }

        function updateBadge() {
            const badge = document.getElementById('ongoing-badge');
            badge.innerText = ongoingOrders.length;
            badge.classList.toggle('hidden', ongoingOrders.length === 0);
        }

        function renderOngoingTab() {
            if(ongoingOrders.length===0) { document.getElementById('main-content').innerHTML = `<div class="text-center py-20 text-gray-300">目前無進行中訂單</div>`; return; }
            document.getElementById('main-content').innerHTML = ongoingOrders.map((o, idx) => `
                <div class="order-card">
                    <div class="flex justify-between items-start mb-3 border-b pb-2">
                        <div><span class="font-black text-lg">#${String(o.id).padStart(3,'0')}</span><span class="ml-2 text-xs text-gray-400">${o.time}</span></div>
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold ${o.status==='未付'?'bg-red-100 text-red-500':'bg-green-100 text-green-600'}">${o.status} (${o.payment})</span>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${o.items.map(i => `<div class="text-sm"><b>${i.name}</b> <span class="text-[10px] text-gray-400">(${i.half!=='none'?'拼'+HALF_FLAVORS.find(h=>h.id===i.half).name+', ':''}${Object.entries(i.customs).map(([k,v])=>v!=='正常'?k+v:'').filter(v=>v).join(' ')}${i.addons.length?', '+i.addons.map(aid=>ADDONS.find(a=>a.id===aid).name).join(' '):''})</span></div>`).join('')}
                    </div>
                    <div class="flex gap-2">
                        ${o.status==='未付' ? `<button onclick="rePay(${idx})" class="flex-1 bg-orange-500 text-white py-2 rounded-xl text-xs font-bold">補付款</button>` : ''}
                        <button onclick="finishOrder(${idx})" class="flex-1 bg-[#8C7A6D] text-white py-2 rounded-xl text-xs font-bold">完成出餐</button>
                    </div>
                </div>
            `).join('');
        }

        function rePay(idx) {
            const p = prompt("請選擇補付款方式：1.現金 2.行動支付 3.Panda 4.Uber");
            const methods = { '1':'現金', '2':'行動支付', '3':'Foodpanda', '4':'UberEats' };
            if(methods[p]) { ongoingOrders[idx].payment = methods[p]; ongoingOrders[idx].status = '已付'; renderOngoingTab(); }
        }

        function finishOrder(idx) {
            if(ongoingOrders[idx].status === '未付') { alert('此訂單尚未付款，請先補付款！'); return; }
            dailyOrders.push(ongoingOrders[idx]);
            ongoingOrders.splice(idx, 1);
            showTab('ongoing');
            updateBadge();
        }

        function renderHistoryTab() {
            const rev = dailyOrders.reduce((s,o)=>s+o.total,0);
            const stats = dailyOrders.reduce((acc, o) => { acc[o.payment] = (acc[o.payment]||0)+o.total; return acc; }, {});
            
            document.getElementById('main-content').innerHTML = `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm mb-4 text-center">
                    <p class="text-[10px] font-bold text-gray-400 mb-1">今日總營業額</p>
                    <p class="text-4xl font-black text-[#8C7A6D] font-mono">$${rev}</p>
                    <div class="flex justify-around mt-4 text-[9px] font-bold text-gray-400 border-t pt-4">
                        <div>現金<br>$${stats['現金']||0}</div><div>行動<br>$${stats['行動支付']||0}</div>
                        <div>Panda<br>$${stats['Foodpanda']||0}</div><div>Uber<br>$${stats['UberEats']||0}</div>
                    </div>
                    <button onclick="clearDay()" class="w-full mt-4 py-3 bg-[#5C544B] text-white rounded-xl text-[10px] font-bold">清帳並存入歷史</button>
                </div>
                <h3 class="font-bold text-sm mb-3 px-2">今日明細</h3>
                ${dailyOrders.map(o => `
                    <div class="bg-white p-4 rounded-2xl mb-2 text-xs border border-gray-100">
                        <div class="flex justify-between font-bold mb-2"><span>#${String(o.id).padStart(3,'0')} (${o.payment})</span><span>$${o.total}</span></div>
                        <div class="space-y-1 text-gray-400 text-[10px]">
                            ${o.items.map(i => `• ${i.name}${i.half!=='none'?'拼'+HALF_FLAVORS.find(h=>h.id===i.half).name:''} (${Object.entries(i.customs).map(([k,v])=>v!=='正常'?k+v:'').filter(v=>v).join(' ') || '標配'})`).join('<br>')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function clearDay() {
            if(confirm('確定要執行清帳嗎？')){
                const logs = JSON.parse(localStorage.getItem('pos_history')||'[]');
                logs.unshift({ date: new Date().toLocaleString(), total: dailyOrders.reduce((s,o)=>s+o.total,0), count: dailyOrders.length });
                localStorage.setItem('pos_history', JSON.stringify(logs));
                dailyOrders = []; orderNum = 1; document.getElementById('order-id-display').innerText = '#001';
                showTab('history');
            }
        }

        init();
    </script>
</body>
</html>
