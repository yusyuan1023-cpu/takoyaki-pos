// --- Firebase 配置與初始化 ---
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";

const firebaseConfig = {
  apiKey: "AIzaSyBCkW3PeRzi23aKx4LiZL68FpwJb39NubQ",
  authDomain: "takoyaki-pos.firebaseapp.com",
  projectId: "takoyaki-pos",
  storageBucket: "takoyaki-pos.firebasestorage.app",
  messagingSenderId: "819656860400",
  appId: "1:819656860400:web:0c8d3723d2d86ee04a9835",
  measurementId: "G-7REF6XLCE4"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

// --- 配置數據 ---
const MENU_ITEMS = [
  { id: 1, name: '原味章魚燒', price: 60 },
  { id: 2, name: '海苔章魚燒', price: 60 },
  { id: 3, name: '芥末章魚燒', price: 60 },
  { id: 4, name: '梅子章魚燒', price: 60 },
  { id: 5, name: '辣味章魚燒', price: 60 },
  { id: 6, name: '蜂蜜芥末章魚燒', price: 60 },
  { id: 7, name: '咖哩章魚燒', price: 60 },
  { id: 8, name: '金沙鹹蛋黃章魚燒', price: 70 },
  { id: 9, name: '起司章魚燒', price: 70 },
  { id: 10, name: '龍蝦沙拉章魚燒', price: 80 },
];

const CUSTOM_OPTIONS = [
  { id: 'mayo', name: '美乃滋' },
  { id: 'soy', name: '醬油' },
  { id: 'flakes', name: '柴魚片' }
];

const ADD_ONS = [
  { id: 'spicy', name: '加辣', price: 5 },
  { id: 'wasabi', name: '加芥末', price: 5 },
  { id: 'seaweed', name: '加海苔', price: 5 },
  { id: 'cheese', name: '加起司', price: 10 },
];

const HALF_OPTIONS = [
  { id: 'original', name: '原味', price: 0 },
  { id: 'spicy', name: '辣味', price: 0 },
  { id: 'seaweed', name: '海苔', price: 0 },
  { id: 'wasabi', name: '芥末', price: 0 },
  { id: 'plum', name: '梅子', price: 0 },
  { id: 'honey', name: '蜂蜜芥末', price: 0 },
  { id: 'curry', name: '咖哩', price: 0 },
  { id: 'salted_egg', name: '金沙', price: 5 },
  { id: 'cheese', name: '起司', price: 5 },
  { id: 'lobster', name: '龍蝦', price: 10 },
];

const LEVELS = ['正常', '不要', '多', '少'];

// --- 輔助組件 ---
const CustomBadges = ({ customs, addOns = [], secondFlavor = null }) => {
  const activeCustoms = Object.entries(customs).filter(([_, value]) => value !== '正常');
  if (activeCustoms.length === 0 && addOns.length === 0 && !secondFlavor) return null;

  return (
    <div className="flex flex-wrap gap-1 mt-1">
      {secondFlavor && (
        <span className="bg-[#EAE4D3] text-[#7A6E5D] text-[10px] px-1.5 py-0.5 rounded-md border border-[#DED5BC] font-medium">
          拼口味: {secondFlavor.name}
        </span>
      )}
      {activeCustoms.map(([key, value]) => {
        const label = CUSTOM_OPTIONS.find(opt => opt.id === key)?.name;
        return (
          <span key={key} className="bg-[#F2EBE5] text-[#8C7A6D] text-[10px] px-1.5 py-0.5 rounded-md border border-[#E6D9CF] font-medium">
            {label}: {value}
          </span>
        );
      })}
      {addOns.map(id => {
        const item = ADD_ONS.find(a => a.id === id);
        return (
          <span key={id} className="bg-[#E9EDF0] text-[#5D6F7A] text-[10px] px-1.5 py-0.5 rounded-md border border-[#D5DEE3] font-medium">
            +{item?.name}
          </span>
        )}
      )}
    </div>
  );
};

const NavButton = ({ active, onClick, icon, label, count }) => (
  <button 
    onClick={onClick} 
    className={`flex flex-col items-center justify-center gap-1 transition-all relative ${active ? 'text-[#8C7A6D]' : 'text-[#8C7E6D]/50 hover:text-[#8C7A6D]'}`}
  >
    <div className="relative">
      {React.cloneElement(icon, { size: 18 })}
      {count > 0 && (
        <span className="absolute -top-1.5 -right-2 bg-[#B5A4A3] text-white text-[9px] min-w-[14px] h-[14px] rounded-full flex items-center justify-center font-bold px-0.5 shadow-sm">
          {count}
        </span>
      )}
    </div>
    <span className={`text-[11px] font-bold ${active ? 'opacity-100' : 'opacity-80'}`}>{label}</span>
    {active && <div className="absolute -bottom-1.5 left-3 right-3 h-0.5 bg-[#8C7A6D] rounded-full" />}
  </button>
);

const StatCard = ({ icon, label, value, bgColor, isBold }) => (
  <div className={`${bgColor} p-3 rounded-2xl border border-[#E8E2D9] flex items-center gap-2.5 shadow-sm`}>
    <div className="p-1 bg-white/60 rounded-md shrink-0 shadow-sm">{React.cloneElement(icon, { size: 14 })}</div>
    <div className="min-w-0">
      <p className="text-[9px] font-bold text-[#A6998A] tracking-wider mb-0.5 uppercase">{label}</p>
      <p className={`text-sm font-mono truncate ${isBold ? 'font-black text-[#5C544B]' : 'font-bold text-[#7A6E5D]'}`}>
        ${value.toLocaleString()}
      </p>
    </div>
  </div>
);

const PaymentOption = ({ onClick, icon, label, color }) => {
  const colorMap = {
    orange: 'bg-[#F2E6D9] text-[#A67C52]',
    emerald: 'bg-[#E6F2EB] text-[#52A67C]',
    pink: 'bg-[#F2E6E6] text-[#A65252]',
    green: 'bg-[#EDF2E6] text-[#7CA652]',
    slate: 'bg-[#F0F0F0] text-[#707070]'
  };
  return (
    <button onClick={onClick} className="w-full flex items-center gap-3 p-4 bg-[#FAF9F7] rounded-2xl border border-[#EDECE8] hover:border-[#8C7A6D]/30 transition-all group active:scale-[0.98] text-left text-sm font-bold text-[#5C544B]">
      <div className={`${colorMap[color]} p-1.5 rounded-lg group-hover:scale-110 transition-transform shrink-0 shadow-sm`}>{React.cloneElement(icon, { size: 18 })}</div>
      {label}
    </button>
  );
};

// --- 主應用程式 ---
export default function App() {
  const [activeTab, setActiveTab] = useState('order'); 
  const [cart, setCart] = useState([]);
  const [ongoingOrders, setOngoingOrders] = useState([]);
  const [completedOrders, setCompletedOrders] = useState([]);
  const [clearanceHistory, setClearanceHistory] = useState([]); 
  const [orderCounter, setOrderCounter] = useState(1);
  const [lastClearDate, setLastClearDate] = useState(new Date().toLocaleDateString());
  
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isCheckoutModalOpen, setIsCheckoutModalOpen] = useState(false);
  const [isChangeAlertOpen, setIsChangeAlertOpen] = useState(false);
  const [paymentStep, setPaymentStep] = useState('select');
  const [cashReceived, setCashReceived] = useState('');
  
  const [pendingPaymentOrder, setPendingPaymentOrder] = useState(null);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [editingCartId, setEditingCartId] = useState(null); 
  const [tempCustoms, setTempCustoms] = useState({ mayo: '正常', soy: '正常', flakes: '正常' });
  const [tempAddOns, setTempAddOns] = useState([]);
  const [tempSecondFlavor, setTempSecondFlavor] = useState(null);
  const [isHalfMode, setIsHalfMode] = useState(false);

  const [refundConfirmOrder, setRefundConfirmOrder] = useState(null);
  const [unpaidAlertOrder, setUnpaidAlertOrder] = useState(null);
  const [showAutoClearAlert, setShowAutoClearAlert] = useState(false);
  const [clearedData, setClearedData] = useState(null);
  const [selectedHistoryLog, setSelectedHistoryLog] = useState(null);
  const [isManualClearConfirmOpen, setIsManualClearConfirmOpen] = useState(false);

  const calculateStats = (orders) => {
    return orders.reduce((acc, order) => {
      if (order.isPaid && !order.isRefunded) {
        if (order.paymentMethod === '現金') acc.cash += order.total;
        else if (order.paymentMethod === '行動支付') acc.linePay += order.total;
        else if (order.paymentMethod === 'Foodpanda') acc.panda += order.total;
        else if (order.paymentMethod === 'UberEats') acc.uber += order.total;
        acc.total += order.total;
      }
      return acc;
    }, { cash: 0, linePay: 0, panda: 0, uber: 0, total: 0 });
  };

  const executeClearance = (isManual = false) => {
    const dailyStats = calculateStats(completedOrders);
    
    if (completedOrders.length > 0) {
      const newLog = {
        id: Date.now(),
        date: isManual ? `${new Date().toLocaleDateString()} (手動)` : lastClearDate,
        clearTime: new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' }),
        stats: dailyStats,
        orderCount: completedOrders.length
      };
      setClearanceHistory(prev => [newLog, ...prev]);
      
      if (!isManual) {
        setClearedData(newLog);
        setShowAutoClearAlert(true);
      }
    }

    setCompletedOrders([]);
    setOrderCounter(1);
    setLastClearDate(new Date().toLocaleDateString());
  };

  useEffect(() => {
    const checkTimeAndClear = () => {
      const now = new Date();
      const todayString = now.toLocaleDateString();
      if (todayString !== lastClearDate) {
        executeClearance(false);
      }
    };
    const timer = setInterval(checkTimeAndClear, 60000); 
    return () => clearInterval(timer);
  }, [lastClearDate, completedOrders]);

  const currentTotal = useMemo(() => {
    if (pendingPaymentOrder) return pendingPaymentOrder.total;
    return cart.reduce((sum, item) => sum + item.finalPrice * item.quantity, 0);
  }, [cart, pendingPaymentOrder]);

  const changeAmount = useMemo(() => {
    const received = parseInt(cashReceived) || 0;
    return received > 0 ? Math.max(0, received - currentTotal) : 0;
  }, [cashReceived, currentTotal]);

  const stats = useMemo(() => calculateStats(completedOrders), [completedOrders]);

  const openEditModal = (item) => {
    setSelectedProduct(MENU_ITEMS.find(m => m.id === item.id));
    setEditingCartId(item.cartId);
    setTempCustoms({ ...item.customs });
    setTempAddOns([...item.addOns]);
    setIsHalfMode(!!item.secondFlavor);
    setTempSecondFlavor(item.secondFlavor);
  };

  const handleConfirmAction = () => {
    const addOnTotal = tempAddOns.reduce((sum, id) => {
        const item = ADD_ONS.find(a => a.id === id);
        return sum + (item?.price || 0);
    }, 0);
    const halfExtra = (isHalfMode && tempSecondFlavor) ? tempSecondFlavor.price : 0;
    const finalPrice = selectedProduct.price + addOnTotal + halfExtra;

    if (editingCartId) {
      setCart(cart.map(item => item.cartId === editingCartId ? {
        ...item,
        customs: { ...tempCustoms },
        addOns: [...tempAddOns],
        secondFlavor: isHalfMode ? tempSecondFlavor : null,
        finalPrice: finalPrice
      } : item));
    } else {
      setCart([...cart, { 
          ...selectedProduct, 
          cartId: Date.now(), 
          customs: { ...tempCustoms }, 
          addOns: [...tempAddOns],
          secondFlavor: isHalfMode ? tempSecondFlavor : null,
          finalPrice: finalPrice,
          quantity: 1 
      }]);
    }

    setSelectedProduct(null);
    setEditingCartId(null);
    setTempAddOns([]);
    setTempSecondFlavor(null);
    setIsHalfMode(false);
  };

  const toggleAddOn = (id) => {
    setTempAddOns(prev => prev.includes(id) ? prev.filter(a => a !== id) : [...prev, id]);
  };

  const completeOrder = (method, received = 0) => {
    if (pendingPaymentOrder) {
      setOngoingOrders(prev => prev.map(o => o.uniqueId === pendingPaymentOrder.uniqueId ? {
        ...o,
        paymentMethod: method,
        received: received || 0,
        isPaid: method !== '未付款'
      } : o));
      setPendingPaymentOrder(null);
    } else {
      const newOrder = {
        uniqueId: Date.now(),
        id: orderCounter.toString().padStart(3, '0'),
        items: [...cart],
        total: currentTotal,
        paymentMethod: method,
        received: received || 0,
        timestamp: new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' }),
        isPaid: method !== '未付款',
        isRefunded: false
      };
      setOngoingOrders([newOrder, ...ongoingOrders]);
      setCart([]);
      setOrderCounter(prev => prev >= 999 ? 1 : prev + 1);
    }

    setIsChangeAlertOpen(false);
    setIsCheckoutModalOpen(false);
    setIsCartOpen(false);
    setPaymentStep('select');
  };

  const handleRefund = (uniqueId) => {
    setCompletedOrders(prev => prev.map(o => o.uniqueId === uniqueId ? { ...o, isRefunded: true } : o));
    setRefundConfirmOrder(null);
  };

  const handleFinishOrder = (order) => {
    if (!order.isPaid) {
      setUnpaidAlertOrder(order);
      return;
    }
    setCompletedOrders([{ ...order, finishedAt: new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' }) }, ...completedOrders]);
    setOngoingOrders(ongoingOrders.filter(o => o.uniqueId !== order.uniqueId));
  };

  return (
    <div className="flex flex-col h-screen bg-[#F7F5F0] font-sans text-[#5C544B] overflow-hidden select-none">
      
      {/* 導覽列 */}
      <nav className="bg-[#FAF9F7] text-[#8C7A6D] shadow-sm z-[50] flex items-center px-4 shrink-0 h-16 border-b border-[#E8E2D9]">
        <div className="flex-1 flex justify-around">
          <NavButton active={activeTab === 'order'} onClick={() => setActiveTab('order')} icon={<UtensilsCrossed />} label="點餐選單" />
          <NavButton active={activeTab === 'ongoing'} onClick={() => setActiveTab('ongoing')} icon={<ClipboardList />} label="製作名單" count={ongoingOrders.length} />
          <NavButton active={activeTab === 'history'} onClick={() => setActiveTab('history')} icon={<History />} label="數據回顧" />
        </div>
        <div className="flex items-center gap-4 border-l border-[#E8E2D9] ml-4 pl-4 py-1">
          <div className="text-right">
            <span className="text-[8px] block text-[#A6998A] font-bold tracking-widest mb-0.5">當前單號</span>
            <span className="font-mono font-black text-[#5C544B] text-lg">#{orderCounter.toString().padStart(3, '0')}</span>
          </div>
          <div className="bg-[#F2EBE5] p-1.5 rounded-lg shadow-inner border border-[#E6D9CF]">
            <Store size={16} className="text-[#8C7A6D]" />
          </div>
        </div>
      </nav>

      <main className="flex-1 relative overflow-hidden">
        {activeTab === 'order' && (
          <div className="h-full overflow-y-auto p-4 pb-32">
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
              {MENU_ITEMS.map(item => (
                <button 
                  key={item.id} 
                  onClick={() => { 
                    setSelectedProduct(item); 
                    setEditingCartId(null);
                    setTempCustoms({ mayo: '正常', soy: '正常', flakes: '正常' }); 
                    setTempAddOns([]);
                    setIsHalfMode(false);
                    setTempSecondFlavor(null);
                  }} 
                  className="bg-white p-4 rounded-3xl shadow-sm border border-[#E8E2D9] flex flex-col items-start hover:shadow-md hover:border-[#8C7A6D]/30 active:scale-[0.97] transition-all text-left group"
                >
                  <span className="text-[12px] font-bold text-[#5C544B] mb-4 line-clamp-2 h-9 leading-relaxed font-serif">{item.name}</span>
                  <div className="flex justify-between items-center w-full mt-auto">
                    <span className="text-[#8C7A6D] font-mono font-black text-sm">${item.price}</span>
                    <div className="bg-[#F2EBE5] text-[#8C7A6D] p-1.5 rounded-lg group-hover:bg-[#8C7A6D] group-hover:text-white transition-all">
                      <Plus size={12} />
                    </div>
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'ongoing' && (
          <div className="h-full overflow-y-auto p-4 space-y-3">
            {ongoingOrders.length === 0 ? (
              <div className="h-full flex flex-col items-center justify-center opacity-30 grayscale">
                <ClipboardList size={60}/>
                <p className="text-xs font-bold mt-4 tracking-widest">目前尚未有製作中的訂單</p>
              </div>
            ) : (
              ongoingOrders.map(order => (
                <div key={order.uniqueId} className="bg-white border border-[#E8E2D9] rounded-[1.8rem] p-4 shadow-sm flex items-center gap-4">
                  <div className="shrink-0 bg-[#F2EBE5] text-[#8C7A6D] w-14 h-14 rounded-2xl flex flex-col items-center justify-center shadow-inner border border-[#E6D9CF]">
                    <span className="text-[8px] font-black opacity-60">單號</span>
                    <span className="font-mono font-black text-base">{order.id}</span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="space-y-1.5 mb-2">
                      {order.items.map((i, idx) => (
                        <div key={idx} className="flex flex-col">
                          <div className="flex items-center gap-2">
                            <span className="text-[13px] font-bold text-[#5C544B] font-serif">{i.name}</span>
                            <span className="text-[10px] font-mono text-[#A6998A] bg-[#FAF9F7] px-1.5 py-0.5 rounded-md border border-[#EDECE8]">x{i.quantity}</span>
                          </div>
                          <CustomBadges customs={i.customs} addOns={i.addOns} secondFlavor={i.secondFlavor} />
                        </div>
                      ))}
                    </div>
                    <div className="flex flex-wrap items-center gap-2 text-[10px] font-bold mt-2">
                      <span className="text-[#A6998A] flex items-center gap-1"><Clock size={10}/> {order.timestamp}</span>
                      <span className={`px-2 py-0.5 rounded-md ${order.isPaid ? 'bg-[#E6F2EB] text-[#52A67C]' : 'bg-[#F2E6E6] text-[#A65252]'}`}>
                        {order.isPaid ? order.paymentMethod : '未付款'}
                      </span>
                      {!order.isPaid && (
                        <button 
                          onClick={() => {
                            setPendingPaymentOrder(order);
                            setPaymentStep('select');
                            setIsCheckoutModalOpen(true);
                          }}
                          className="bg-[#B5A4A3] text-white px-2 py-0.5 rounded-md flex items-center gap-1 hover:opacity-90 active:scale-95 transition-all shadow-sm"
                        >
                          <DollarSign size={10}/> 補付 (${order.total})
                        </button>
                      )}
                    </div>
                  </div>
                  <button 
                    onClick={() => handleFinishOrder(order)} 
                    className={`px-6 py-4 rounded-xl font-bold text-xs transition-all ${order.isPaid ? 'bg-[#8C7A6D] text-white shadow-md active:scale-95 hover:opacity-90' : 'bg-stone-100 text-stone-300 cursor-not-allowed opacity-50'}`}
                  >
                    出餐
                  </button>
                </div>
              ))
            )}
          </div>
        )}

        {activeTab === 'history' && (
          <div className="h-full overflow-y-auto p-4 space-y-4 pb-24">
             <div className="grid grid-cols-2 gap-3">
              <StatCard icon={<Banknote />} label="現金收入" value={stats.cash} bgColor="bg-white" />
              <StatCard icon={<Smartphone />} label="行動支付" value={stats.linePay} bgColor="bg-white" />
              <StatCard icon={<Truck />} label="Foodpanda" value={stats.panda} bgColor="bg-white" />
              <StatCard icon={<Truck />} label="UberEats" value={stats.uber} bgColor="bg-white" />
              <div className="col-span-2">
                 <StatCard icon={<TrendingUp className="text-[#8C7A6D]"/>} label="今日預估總營收" value={stats.total} bgColor="bg-[#F2EBE5] border-[#E6D9CF]" isBold />
              </div>
            </div>

            <div className="bg-white rounded-[1.8rem] p-5 shadow-sm border border-[#E8E2D9]">
              <div className="flex justify-between items-center mb-4">
                <p className="text-[10px] font-black text-[#A6998A] tracking-widest uppercase">已完成訂單紀錄</p>
                <span className="text-[9px] font-bold text-stone-300">午夜自動結算</span>
              </div>
              <div className="divide-y divide-stone-100 max-h-80 overflow-y-auto pr-1">
                {completedOrders.length === 0 ? (
                  <p className="text-center text-[10px] py-10 text-stone-300 font-bold tracking-widest uppercase">目前暫無數據</p>
                ) : (
                  completedOrders.map(o => (
                    <div key={o.uniqueId} className={`py-4 flex flex-col gap-2 ${o.isRefunded ? 'opacity-40' : ''}`}>
                      <div className="flex justify-between items-start">
                        <div className="flex flex-col gap-0.5">
                          <div className="flex items-center gap-2">
                            <span className={`text-xs font-black ${o.isRefunded ? 'line-through text-stone-400' : 'text-[#5C544B]'}`}>
                              單號 #{o.id} · {o.paymentMethod}
                            </span>
                            {o.isRefunded && <span className="bg-[#F2E6E6] text-[#A65252] text-[8px] px-1.5 py-0.5 rounded font-bold">已退款</span>}
                          </div>
                          <span className="text-[9px] text-[#A6998A] font-bold">{o.finishedAt} 已出餐</span>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className={`font-mono font-black text-sm ${o.isRefunded ? 'line-through text-stone-300' : 'text-[#8C7A6D]'}`}>${o.total}</span>
                          {o.isPaid && !o.isRefunded && (
                            <button 
                              onClick={() => setRefundConfirmOrder(o)}
                              className="text-[#A65252] border border-[#F2E6E6] bg-[#F2E6E6]/50 px-2 py-1 rounded-lg font-bold text-[9px] hover:bg-[#A65252] hover:text-white transition-all active:scale-95"
                            >
                              退款
                            </button>
                          )}
                        </div>
                      </div>
                      {/* 歷史清單中的餐點明細 */}
                      <div className="bg-[#FAF9F7] p-2.5 rounded-xl border border-[#EDECE8] space-y-2">
                        {o.items.map((item, idx) => (
                          <div key={idx} className="flex flex-col text-[11px]">
                            <div className="flex justify-between items-center text-[#5C544B] font-bold">
                              <span>{item.name} x{item.quantity}</span>
                              <span className="font-mono text-[10px]">${item.finalPrice * item.quantity}</span>
                            </div>
                            <CustomBadges customs={item.customs} addOns={item.addOns} secondFlavor={item.secondFlavor} />
                          </div>
                        ))}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>

            <div className="bg-[#7A6E5D] rounded-[1.8rem] p-5 shadow-lg">
               <div className="flex items-center justify-between mb-5">
                 <div className="flex items-center gap-2.5 text-white">
                   <div className="p-1 bg-white/10 rounded-md border border-white/20"><BookOpen size={12} className="text-[#EAE4D3]" /></div>
                   <p className="text-[10px] font-black tracking-widest">清帳日記</p>
                 </div>
                 <button 
                  onClick={() => setIsManualClearConfirmOpen(true)}
                  className="bg-[#EAE4D3] hover:bg-[#DED5BC] text-[#5C544B] px-3 py-1.5 rounded-lg flex items-center gap-2 transition-all active:scale-95 shadow-md"
                 >
                   <LogOut size={12} />
                   <span className="text-[10px] font-black">執行清帳</span>
                 </button>
               </div>
               
               <div className="space-y-2">
                 {clearanceHistory.length === 0 ? (
                   <div className="py-8 text-center border border-white/5 rounded-xl bg-white/5">
                     <p className="text-[10px] text-white/30 font-bold tracking-widest">目前尚無紀錄</p>
                   </div>
                 ) : (
                   clearanceHistory.map(log => (
                     <button 
                        key={log.id} 
                        onClick={() => setSelectedHistoryLog(log)}
                        className="w-full bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl p-3 flex items-center justify-between transition-all active:scale-[0.98]"
                     >
                       <div className="text-left">
                         <p className="text-xs font-black text-white">{log.date}</p>
                         <p className="text-[9px] text-white/40 font-mono mt-0.5">{log.clearTime} • {log.orderCount} 筆單</p>
                       </div>
                       <div className="flex items-center gap-3">
                         <p className="text-xs font-black text-[#EAE4D3]">${log.stats.total.toLocaleString()}</p>
                         <ChevronDown size={14} className="text-white/20" />
                       </div>
                     </button>
                   ))
                 )}
               </div>
            </div>
          </div>
        )}

        {cart.length > 0 && activeTab === 'order' && (
          <div className="absolute bottom-8 right-6 z-40">
            <button 
              onClick={() => setIsCartOpen(true)}
              className="bg-[#8C7A6D] text-white p-4 rounded-[2rem] shadow-2xl flex items-center gap-4 hover:scale-105 active:scale-95 transition-all border-4 border-white"
            >
              <div className="relative">
                <ShoppingCart size={24} />
                <span className="absolute -top-2 -right-2 bg-[#B5A4A3] text-[9px] w-6 h-6 rounded-full flex items-center justify-center font-black border-2 border-[#8C7A6D] shadow-sm">{cart.length}</span>
              </div>
              <div className="pr-1 text-left border-l border-white/20 pl-4">
                <span className="text-[8px] block opacity-70 font-bold tracking-widest mb-0.5 uppercase">TOTAL</span>
                <span className="text-xl font-black font-mono leading-none">${currentTotal}</span>
              </div>
              <ChevronRight size={16} className="opacity-40 ml-1" />
            </button>
          </div>
        )}
      </main>

      {/* 手動清帳確認 */}
      {isManualClearConfirmOpen && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-[1100] p-6 text-center">
          <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 shadow-2xl border-t-[8px] border-[#B5A4A3]">
            <div className="w-16 h-16 bg-[#F2EBE5] text-[#8C7A6D] rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-[#E6D9CF]">
              <LogOut size={28} />
            </div>
            <h4 className="font-serif font-black text-xl text-[#5C544B] mb-3">執行結算清帳？</h4>
            <p className="text-xs text-[#A6998A] mb-8 leading-relaxed px-4 font-medium">
              此動作將結算今日數據並存入日記，訂單紀錄將歸零。建議於歇業後執行。
            </p>
            <div className="space-y-3">
              <button 
                onClick={() => {
                  executeClearance(true);
                  setIsManualClearConfirmOpen(false);
                }}
                className="w-full py-4 bg-[#8C7A6D] text-white rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all"
              >
                確認結算清帳
              </button>
              <button 
                onClick={() => setIsManualClearConfirmOpen(false)}
                className="w-full py-2 text-[#A6998A] font-bold text-[10px] tracking-widest"
              >
                取消返回
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 清帳日記詳情 */}
      {selectedHistoryLog && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[1100] p-6 text-center">
          <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 shadow-2xl border-t-[8px] border-[#7A6E5D]">
            <div className="w-14 h-14 bg-[#F2EBE5] text-[#7A6E5D] rounded-full flex items-center justify-center mx-auto mb-5">
              <BookOpen size={24} />
            </div>
            <h4 className="font-serif font-black text-lg text-[#5C544B] tracking-tight mb-6">{selectedHistoryLog.date} 結算詳情</h4>
            
            <div className="bg-[#FAF9F7] rounded-2xl p-5 space-y-3 mb-8 text-left border border-[#EDECE8]">
              <div className="flex justify-between items-center pb-2 border-b border-[#E8E2D9]">
                <span className="text-[11px] font-bold text-[#A6998A] flex items-center gap-2"><Banknote size={14}/> 現金收款</span>
                <span className="font-mono font-black text-[#A67C52]">${selectedHistoryLog.stats.cash.toLocaleString()}</span>
              </div>
              <div className="flex justify-between items-center pb-2 border-b border-[#E8E2D9]">
                <span className="text-[11px] font-bold text-[#A6998A] flex items-center gap-2"><Smartphone size={14}/> 行動支付</span>
                <span className="font-mono font-black text-[#52A67C]">${selectedHistoryLog.stats.linePay.toLocaleString()}</span>
              </div>
              <div className="flex justify-between items-center pb-2 border-b border-[#E8E2D9]">
                <span className="text-[11px] font-bold text-[#A6998A] flex items-center gap-2"><Truck size={14}/> Foodpanda</span>
                <span className="font-mono font-black text-[#A65252]">${selectedHistoryLog.stats.panda.toLocaleString()}</span>
              </div>
              <div className="flex justify-between items-center pb-2 border-b border-[#E8E2D9]">
                <span className="text-[11px] font-bold text-[#A6998A] flex items-center gap-2"><Truck size={14}/> UberEats</span>
                <span className="font-mono font-black text-[#7CA652]">${selectedHistoryLog.stats.uber.toLocaleString()}</span>
              </div>
              <div className="flex justify-between items-center pt-1">
                <span className="text-sm font-black text-[#5C544B]">當日總計</span>
                <span className="text-xl font-mono font-black text-[#8C7A6D]">${selectedHistoryLog.stats.total.toLocaleString()}</span>
              </div>
            </div>

            <button 
              onClick={() => setSelectedHistoryLog(null)}
              className="w-full py-4 bg-[#5C544B] text-white rounded-2xl font-black text-sm active:scale-95 transition-all shadow-lg"
            >
              關閉視窗
            </button>
          </div>
        </div>
      )}

      {/* 自動清帳通知 */}
      {showAutoClearAlert && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-[1000] p-6 text-center">
          <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 shadow-2xl border-t-[8px] border-[#8C7A6D]">
            <div className="w-16 h-16 bg-[#E6F2EB] text-[#52A67C] rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
              <CalendarCheck size={32} />
            </div>
            <h4 className="font-serif font-black text-xl text-[#5C544B] mb-3">系統自動清帳</h4>
            <p className="text-xs text-[#A6998A] mb-8 leading-relaxed font-medium">
              午夜已過，已自動結算昨日數據。昨日營收 <span className="font-black text-[#8C7A6D] text-lg">${clearedData?.stats.total.toLocaleString()}</span>。
            </p>
            <button 
              onClick={() => setShowAutoClearAlert(false)}
              className="w-full py-4 bg-[#8C7A6D] text-white rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all"
            >
              開啟新的一天
            </button>
          </div>
        </div>
      )}

      {/* 退款確認 */}
      {refundConfirmOrder && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[500] p-6 text-center">
          <div className="bg-white rounded-[2rem] w-full max-w-xs p-8 shadow-2xl">
            <div className="w-14 h-14 bg-[#F2E6E6] text-[#A65252] rounded-full flex items-center justify-center mx-auto mb-5">
              <Undo2 size={24} />
            </div>
            <h4 className="font-serif font-black text-lg text-[#5C544B] mb-2">確認退款？</h4>
            <p className="text-xs text-[#A6998A] mb-8 font-medium leading-relaxed">
              單號 #{refundConfirmOrder.id} 的 <span className="font-bold text-[#A65252]">${refundConfirmOrder.total}</span> 元。<br/>執行後將無法取消。
            </p>
            <div className="flex flex-col gap-2">
              <button 
                onClick={() => handleRefund(refundConfirmOrder.uniqueId)}
                className="w-full py-4 bg-[#A65252] text-white rounded-2xl font-black text-sm shadow-lg active:scale-95 transition-all"
              >
                確認退款
              </button>
              <button 
                onClick={() => setRefundConfirmOrder(null)}
                className="w-full py-1.5 text-[#A6998A] font-bold text-[10px] tracking-widest"
              >
                返回
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 未付款警告 */}
      {unpaidAlertOrder && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[550] p-6 text-center">
          <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 shadow-2xl border-t-[8px] border-[#A67C52]">
            <div className="w-16 h-16 bg-[#F2E6D9] text-[#A67C52] rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
              <AlertTriangle size={32} />
            </div>
            <h4 className="font-serif font-black text-xl text-[#5C544B] mb-3">無法執行出餐</h4>
            <p className="text-xs text-[#A6998A] mb-8 leading-relaxed font-medium px-4">
              單號 <span className="font-black text-[#A67C52]">#{unpaidAlertOrder.id}</span> 尚未付款。
            </p>
            <div className="space-y-3">
              <button 
                onClick={() => {
                  const orderToPay = unpaidAlertOrder;
                  setUnpaidAlertOrder(null);
                  setPendingPaymentOrder(orderToPay);
                  setPaymentStep('select');
                  setIsCheckoutModalOpen(true);
                }}
                className="w-full py-4 bg-[#A67C52] text-white rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2"
              >
                <DollarSign size={18}/> 立即補付款
              </button>
              <button 
                onClick={() => setUnpaidAlertOrder(null)}
                className="w-full py-1.5 text-[#A6998A] font-bold text-[10px] tracking-widest"
              >
                稍後處理
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 商品細項選項 */}
      {selectedProduct && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[200] p-6">
          <div className="bg-white rounded-[2.5rem] w-full max-w-xs shadow-2xl overflow-hidden flex flex-col max-h-[92vh]">
            <div className="p-5 bg-[#FAF9F7] flex justify-between items-center shrink-0 border-b border-[#E8E2D9]">
              <span className="font-black text-sm font-serif text-[#5C544B]">{editingCartId ? '修改：' : ''}{selectedProduct.name}</span>
              <button onClick={() => { setSelectedProduct(null); setEditingCartId(null); }} className="text-[#A6998A] hover:text-[#5C544B]"><X size={18}/></button>
            </div>
            
            <div className="p-5 space-y-5 overflow-y-auto bg-white">
              <div className="space-y-2">
                <p className="text-[10px] font-black text-[#A6998A] tracking-widest uppercase">口味模式</p>
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={() => { setIsHalfMode(false); setTempSecondFlavor(null); }} className={`py-3 rounded-xl text-[11px] font-bold border-2 transition-all ${!isHalfMode ? 'bg-[#8C7A6D] border-[#8C7A6D] text-white shadow-md' : 'border-[#EDECE8] text-stone-300'}`}>單一</button>
                  <button onClick={() => setIsHalfMode(true)} className={`py-3 rounded-xl text-[11px] font-bold border-2 transition-all ${isHalfMode ? 'bg-[#8C7A6D] border-[#8C7A6D] text-white shadow-md' : 'border-[#EDECE8] text-stone-300'}`}>雙拼</button>
                </div>
              </div>

              {isHalfMode && (
                <div className="space-y-2 animate-in slide-in-from-top-1 duration-200">
                  <p className="text-[10px] font-black text-[#8C7A6D] tracking-widest uppercase">選擇拼味</p>
                  <div className="grid grid-cols-2 gap-2">
                    {HALF_OPTIONS.map(h => (
                      <button key={h.id} onClick={() => setTempSecondFlavor(h)} className={`py-2.5 px-3 rounded-lg text-[10px] font-bold border-2 flex justify-between items-center transition-all ${tempSecondFlavor?.id === h.id ? 'bg-[#F2EBE5] border-[#8C7A6D] text-[#8C7A6D]' : 'border-[#EDECE8] text-stone-400'}`}>
                        <span>{h.name}</span>
                        {h.price > 0 && <span className="font-mono text-[8px] bg-white/60 px-1 py-0.5 rounded border border-stone-100">+${h.price}</span>}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              <div className="pt-1.5 border-t border-[#EDECE8] space-y-4">
                {CUSTOM_OPTIONS.map(opt => (
                  <div key={opt.id} className="space-y-2">
                    <p className="text-[10px] font-black text-[#A6998A] tracking-widest uppercase">{opt.name}</p>
                    <div className="grid grid-cols-4 gap-1.5">
                      {LEVELS.map(l => (
                        <button key={l} onClick={() => setTempCustoms({...tempCustoms, [opt.id]: l})} className={`py-2.5 rounded-lg text-[10px] font-bold border-2 transition-all ${tempCustoms[opt.id] === l ? 'bg-[#5C544B] border-[#5C544B] text-white' : 'border-[#EDECE8] text-stone-300'}`}>{l}</button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>

              <div className="space-y-2 pt-1.5 border-t border-[#EDECE8]">
                <p className="text-[10px] font-black text-[#B5A4A3] tracking-widest uppercase">額外加購</p>
                <div className="grid grid-cols-2 gap-2">
                  {ADD_ONS.map(addon => (
                    <button key={addon.id} onClick={() => toggleAddOn(addon.id)} className={`py-3 px-3 rounded-xl text-[11px] font-bold border-2 flex justify-between items-center transition-all ${tempAddOns.includes(addon.id) ? 'bg-[#F2EBE5] border-[#B5A4A3] text-[#7A6E5D]' : 'border-[#EDECE8] text-stone-400'}`}>
                      <span>{addon.name}</span>
                      <span className="font-mono text-[9px] opacity-60">+${addon.price}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="p-5 border-t bg-[#FAF9F7] shrink-0">
                <button onClick={handleConfirmAction} disabled={isHalfMode && !tempSecondFlavor} className={`w-full py-4 rounded-2xl font-black text-sm flex justify-between px-6 transition-all ${isHalfMode && !tempSecondFlavor ? 'bg-stone-200 text-stone-400 cursor-not-allowed' : 'bg-[#8C7A6D] text-white shadow-xl active:scale-[0.98]'}`}>
                    <span>{editingCartId ? '確認修改' : '加入餐點'}</span>
                    <span className="font-mono">
                        ${selectedProduct.price + tempAddOns.reduce((s, id) => s + (ADD_ONS.find(a => a.id === id)?.price || 0), 0) + ((isHalfMode && tempSecondFlavor) ? tempSecondFlavor.price : 0)}
                    </span>
                </button>
            </div>
          </div>
        </div>
      )}

      {/* 購物車抽屜 */}
      {isCartOpen && (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex justify-end">
          <div className="w-[320px] bg-[#FAF9F7] h-full shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
            <div className="p-5 bg-[#8C7A6D] text-white flex justify-between items-center shrink-0">
              <div className="flex items-center gap-2.5">
                <ShoppingCart size={18} />
                <span className="font-black text-sm tracking-widest font-serif">餐點明細</span>
              </div>
              <button onClick={() => setIsCartOpen(false)} className="bg-white/10 p-1 rounded-md border border-white/20"><X size={14}/></button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#F7F5F0]">
              {cart.map(item => (
                <div 
                  key={item.cartId} 
                  onClick={() => openEditModal(item)}
                  className="bg-white p-4 rounded-[1.5rem] border border-transparent hover:border-[#8C7A6D]/20 shadow-sm cursor-pointer active:scale-[0.98] transition-all relative group"
                >
                  <div className="flex justify-between font-bold text-[13px] mb-1 text-[#5C544B] font-serif">
                    <span className="line-clamp-1">{item.name}</span>
                    <span className="font-mono text-[#8C7A6D] ml-2">${item.finalPrice * item.quantity}</span>
                  </div>
                  <CustomBadges customs={item.customs} addOns={item.addOns} secondFlavor={item.secondFlavor} />
                  
                  <div className="flex justify-between items-center mt-3" onClick={e => e.stopPropagation()}>
                    <div className="flex items-center gap-2 bg-[#FAF9F7] rounded-lg px-2 py-1 border border-[#EDECE8]">
                      <button className="p-0.5 text-[#A6998A] hover:text-[#5C544B]" onClick={() => setCart(cart.map(i => i.cartId === item.cartId ? {...i, quantity: Math.max(1, i.quantity - 1)} : i))}><Minus size={12}/></button>
                      <span className="text-[10px] font-mono font-black w-4 text-center text-[#5C544B]">{item.quantity}</span>
                      <button className="p-0.5 text-[#A6998A] hover:text-[#5C544B]" onClick={() => setCart(cart.map(i => i.cartId === item.cartId ? {...i, quantity: i.quantity + 1} : i))}><Plus size={12}/></button>
                    </div>
                    <button className="p-2 text-stone-300 hover:text-[#A65252]" onClick={() => setCart(cart.filter(i => i.cartId !== item.cartId))}><Trash2 size={16}/></button>
                  </div>
                </div>
              ))}
            </div>
            <div className="p-6 border-t bg-white shrink-0">
              <div className="flex justify-between items-end mb-6">
                <div>
                  <p className="text-[9px] font-black text-[#A6998A] tracking-widest uppercase mb-0.5">應付</p>
                  <p className="text-3xl font-black font-mono text-[#8C7A6D] tracking-tight">${currentTotal}</p>
                </div>
                <span className="text-[10px] font-bold text-stone-300 mb-0.5">{cart.length} 份</span>
              </div>
              <button onClick={() => { setPaymentStep('select'); setIsCheckoutModalOpen(true); }} className="w-full py-4 bg-[#8C7A6D] text-white rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all">選擇結帳</button>
            </div>
          </div>
        </div>
      )}

      {/* 結帳方式選擇 */}
      {isCheckoutModalOpen && (
        <div className="fixed inset-0 bg-[#7A6E5D]/90 backdrop-blur-lg flex items-center justify-center z-[210] p-6 text-center">
          <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 shadow-2xl overflow-hidden max-h-[92vh]">
            {paymentStep === 'select' ? (
              <div className="space-y-3 overflow-y-auto text-left">
                <h3 className="font-serif font-black text-base mb-5 text-center text-[#5C544B]">
                  {pendingPaymentOrder ? `補付單號 #${pendingPaymentOrder.id}` : '結帳方式'}
                </h3>
                <PaymentOption onClick={() => { setPaymentStep('cash_input'); setCashReceived(''); }} icon={<Banknote />} label="現金結帳" color="orange" />
                <PaymentOption onClick={() => completeOrder('行動支付')} icon={<Smartphone />} label="行動支付" color="emerald" />
                <PaymentOption onClick={() => completeOrder('Foodpanda')} icon={<Truck />} label="Foodpanda" color="pink" />
                <PaymentOption onClick={() => completeOrder('UberEats')} icon={<Truck />} label="UberEats" color="green" />
                
                {!pendingPaymentOrder && (
                  <div className="pt-2">
                    <PaymentOption onClick={() => completeOrder('未付款')} icon={<WalletMinimal />} label="現場付款 (待領取)" color="slate" />
                  </div>
                )}

                <button onClick={() => { setIsCheckoutModalOpen(false); setPendingPaymentOrder(null); }} className="w-full mt-4 text-[10px] font-bold text-[#A6998A] tracking-widest text-center">返回取消</button>
              </div>
            ) : (
              <div className="space-y-4 animate-in fade-in zoom-in-95 duration-300">
                <div className="bg-[#5C544B] p-5 rounded-2xl text-center text-white shadow-inner">
                    <p className="text-[9px] opacity-50 font-bold tracking-widest uppercase mb-0.5">應收</p>
                    <p className="text-3xl font-mono font-black">${currentTotal}</p>
                    <p className="text-[9px] opacity-50 mt-3 font-bold tracking-widest uppercase mb-0.5">實收</p>
                    <p className="text-2xl font-mono text-[#EAE4D3] font-black">${cashReceived || '0'}</p>
                </div>
                <div className="grid grid-cols-3 gap-2">
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, '00', 0].map(n => (
                    <button key={n} onClick={() => setCashReceived(prev => prev + String(n))} className="py-4 bg-[#FAF9F7] rounded-xl font-black text-base border border-[#EDECE8] active:scale-[0.9] text-[#5C544B]">{n}</button>
                  ))}
                  <button onClick={() => setCashReceived('')} className="bg-[#F2E6E6] text-[#A65252] rounded-xl font-black border border-[#E6D9CF] active:scale-[0.9]">C</button>
                </div>
                <button onClick={() => setIsChangeAlertOpen(true)} className="w-full py-4 bg-[#8C7A6D] text-white rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all">確認收款</button>
                <button onClick={() => setPaymentStep('select')} className="w-full text-[10px] font-bold text-[#A6998A] mt-1 tracking-widest">返回</button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* 找零金額顯示 */}
      {isChangeAlertOpen && (
        <div className="fixed inset-0 bg-black/85 backdrop-blur-md flex items-center justify-center z-[600] p-6 text-center">
            <div className="bg-white p-10 rounded-[3rem] w-full max-w-xs shadow-2xl animate-in zoom-in duration-300">
                <p className="text-[#A6998A] text-[10px] font-black mb-3 uppercase tracking-widest">找零金額</p>
                <p className="text-5xl font-mono font-black text-[#52A67C] mb-10 tracking-tighter">${changeAmount}</p>
                <button onClick={() => completeOrder('現金', parseInt(cashReceived))} className="w-full py-4 bg-[#5C544B] text-white rounded-2xl font-black text-sm shadow-2xl active:scale-95 transition-all">完成結帳</button>
            </div>
        </div>
      )}
    </div>
  );
}
